<!doctype html>
<html ng-app="app">
<head>
    <!--manifest="demo.appcache"-->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RESTfulFramework接口测试工具</title>
    <link href="Content/jquery.mobile-1.4.5.css" rel="stylesheet" />
    <link href="Content/jquery.mobile.theme-1.4.5.css" rel="stylesheet" />
    <link href="Content//jquery.jsonview.css" rel="stylesheet" />
</head>
<body>
    <script src="Scripts/jquery-2.2.2.min.js"></script>
    <script src="Scripts/JsonView/jquery.jsonview.js"></script>
    <script src="Scripts/jquery.md5.js"></script>
    <script src="Scripts/jquery.mobile-1.4.5.min.js"></script>
    <script src="Scripts/angular.min.js"></script>
    <script src="TypeScript/Sign.js"></script>
    <script src="TypeScript/ConfigInfo.js"></script>
    <script src="TypeScript/HttpHelper.js"></script>
    <script src="TypeScript/UserHttpHelper.js"></script>
    <script src="TypeScript/DbSqliteHelper.js"></script>
    <script src="TypeScript/DataHttpHelper.js"></script>
    <script>

    </script>
    <div data-role="page" data-theme="b" ng-controller="ApiInfoController">
        <div data-role="header">
            <h3>接口测试工具</h3>
        </div>
        <div data-role="content">
            <!--请求内容-->
            <section>
                <label>请求内容：</label>
                <textarea id="bodyTextarea"></textarea>
            </section>

            <!--接口列表-->
            <section>

                <div>
                    <label>url地址参数：</label>
                    <div class="ui-grid-a" ng-repeat="apiForm in apiFormList">
                        <label class="ui-block-a">&nbsp;&nbsp;{{apiForm.key}}</label>
                        <div class="ui-block-b">
                            <input type="text"   name="{{apiForm.key}}" value="{{apiForm.value}}" />
                        </div>

                    </div>
                </div>

                <div class="ui-grid-a">
                    <label id="apiNameListLabel" for="apiNameList" class="ui-block-a">接口名称：</label>
                    <div class="ui-block-b">
                        <select id="apiNameList" ng-model="apiInfoSelected" ng-options="apiInfo.name for apiInfo in apiInfoList" ng-change="SwithApi()"></select>
                    </div>
                </div>

                <!--请求方式-->
                <div class="ui-grid-a">
                    <label id="apiRequestModeLabel" for="apiRequestMode" class="ui-block-a">请求方式：</label>
                    <div class="ui-block-b">
                        <select id="apiRequestMode" ng-model="apiInfoRequestMethod" ng-options="requestMethod.name for requestMethod in apiInfoRequestMethodList" ng-change="SwithRequestMethod()"></select>
                    </div>
                </div>

            </section>

            <!--响应内容-->
            <section>
                <style>
                    #responseDiv > div {
                        background-color: black;
                    }
                </style>
                <div id="responseDiv" data-role="collapsible" data-collapsed="false">
                    <h3>响应内容</h3>
                    <div id="responseView"></div>
                </div>
            </section>
        </div>

        <div data-role="footer" class="ui-footer-fixed">
            <div data-role="navbar" data-iconpos="left">
                <ul>
                    <li><a id="testApiButton" data-icon="arrow-r" ng-click="TestApiClick()">测试</a></li>
                    <li><a id="addApiButton" href="#dialogAddInterfacePage" data-rel="dialog" data-icon="plus">添加</a></li>
                    <li><a id="deleteApiButton" href="#" data-icon="delete">删除</a></li>
                    <li><a id="setConfigButton" href="#dialogSetConfigPage" data-rel="dialog" data-icon="gear">设置</a></li>
                </ul>
            </div>
        </div>

    </div>

    <section id="dialogAddInterfacePage" data-role="page" data-theme="b">
        <div data-role="header">
            <h3>添加接口</h3>
        </div>
        <div data-role="content" class="ui-content">
            <div>
                <input id="apiInfoName" type="text" placeholder="接口中文名称" />
                <input id="apiName" type="text" placeholder="API" />
                <textarea id="requestInfoData" placeholder="请求数据"></textarea>
                <textarea id="apiUrl" placeholder="绝对地址(可选,一般不填)"></textarea>
                <select id="apiInfoRequestMode">
                    <option>POST</option>
                    <option>GET</option>
                </select>
            </div>
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <a id="ok" href="#" data-role="button" data-rel="back">确定</a>
                </div>
                <div class="ui-block-b">
                    <a id="cancel" href="#" data-role="button" data-rel="back">取消</a>
                </div>
            </div>
        </div>

    </section>

    <section id="dialogSetConfigPage" data-role="page" data-theme="b">
        <div data-role="header">
            <h3>设置</h3>
        </div>
        <div data-role="content" class="ui-content">
            <div>
                <input id="apiDataBaseUrl" type="text" placeholder="数据接口基础地址" value="http://www.***.com/DataService" />
                <input id="apiUserBaseUrl" type="text" placeholder="用户接口基础地址" value="http://www.***.com/UserService" />
                <input id="secretKey" placeholder="用于签名的密钥" />
            </div>
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <a id="okSet" href="#" data-role="button" data-rel="back">确定</a>
                </div>
                <div class="ui-block-b">
                    <a id="cancelSet" href="#" data-role="button" data-rel="back">取消</a>
                </div>
            </div>
        </div>

    </section>

    <script>
        function setMiddle(element) {
            //取自已的高度
            var myHeight = $(element).height();
            //取父节点的高度
            var parentHeight = $(element).parent().height();
            //设置margin-top
            $(element).css("margin-top", (parentHeight / 2 - myHeight / 2) + "px");
        }


        function getQueryString(url, name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = url.match(reg);

            if (r != null) return unescape(r[2]); return null;
        }

        //返回的是对象形式的参数
        function getUrlArgObject(url) {
            var args = [];
            var query = url;//获取查询串
            var queryPara = query.split("?")[1];
            var pairs = queryPara.split("&");
            for (var i = 0; i < pairs.length; i++) {
                var pos = pairs[i].indexOf('=');//查找name=value
                if (pos == -1) {//如果没有找到就跳过
                    continue;
                }
                var argname = pairs[i].substr(0, pairs[i].split("=")[0].length);//提取name
                var value = pairs[i].substr(pairs[i].split("=")[0].length + 1, pairs[i].split("=")[1].length);//提取value
                args.push({ key: argname, value: value });
                //args[argname] = unescape(value);//存为属性
            }
            return args;//返回对象
        }
    </script>

    <script>
        var apiInfos = new Object();
        ConfigInfo.BaseDataServiceUrl = localStorage.BaseDataServiceUrl;
        ConfigInfo.BaseUserServiceUrl = localStorage.BaseUserServiceUrl;
        ConfigInfo.SecretKey = localStorage.SecretKey;
    </script>

    <script>

        $(document).ready(function () {

            setMiddle(document.getElementById("apiNameListLabel"));
            setMiddle(document.getElementById("apiRequestModeLabel"));

            $("#apiDataBaseUrl").val(ConfigInfo.BaseDataServiceUrl);;
            $("#apiUserBaseUrl").val(ConfigInfo.BaseUserServiceUrl);;
            $("#secretKey").val(ConfigInfo.SecretKey);;
            $("#addApiButton").click(function () { });
            $("#apiNameList").change(function (eventObject) {
                var itemid = $("#apiNameList").val();
                for (var i = 0; i < apiInfos.length; i++) {
                    if (apiInfos[i].name == itemid) {
                        //请求的body信息
                        $("#bodyTextarea").text(apiInfos[i].body);
                    }
                }
                setMiddle(document.getElementById("apiNameListLabel"));
                setMiddle(document.getElementById("apiRequestModeLabel"));
            });
            $("#ok").click(function () {
                var db = new DbSqliteHelper();
                //apiUrl
                db.CreateApiTestInfo($("#apiName").val(), $("#apiInfoName").val(), $("#requestInfoData").val(), $("#apiInfoRequestMode").val(), $("#apiUrl").val(), function (data, textStatus, jqXHR) {
                    if (data.Code > 0) {
                        alert("添加成功！");
                        window.location.reload();
                    }
                    else {
                        alert("添加失败！");
                    }
                });
            });
            $("#cancel").click(function () {
                $('input').textinput();

            });
            $("#okSet").click(function () {
                localStorage.BaseDataServiceUrl = $("#apiDataBaseUrl").val();
                localStorage.BaseUserServiceUrl = $("#apiUserBaseUrl").val();
                localStorage.SecretKey = $("#secretKey").val();;

                ConfigInfo.BaseDataServiceUrl = $("#apiDataBaseUrl").val();
                ConfigInfo.BaseUserServiceUrl = $("#apiUserBaseUrl").val();
                ConfigInfo.SecretKey = $("#secretKey").val();
                window.location.reload();
            });
            $("#cancelSet").click(function () {
                $("#apiDataBaseUrl").val(ConfigInfo.BaseDataServiceUrl);;
                $("#apiUserBaseUrl").val(ConfigInfo.BaseUserServiceUrl);;
                $("#secretKey").val(ConfigInfo.SecretKey);;
            });

            $("#apiNameList").change(function () {
           
             
                    $('input').textinput();
                    $('select').selectmenu('refresh', true);
              

            });
            $("#apiRequestMode").change(function () {
                //$('select').selectmenu('refresh', true);
            });

            $("input").change(function () {
                $('input').textinput();

            })


            //window.onloadeddata= function () {
            //    $('select').selectmenu('refresh', true);
            //};
        });

      
    </script>

    <!--angular-->

    <script>

        var agModele = angular.module("app", []);
        agModele.controller("ApiInfoController", function ($scope) {
            //取api信息列表
            var db = new DbSqliteHelper();
            db.GetAllTestInfo(function (data, textStatus, jqXHR) {

                if (textStatus == "success") {
                    if (data.Code > 0) {
                        apiInfos = data.Msg;
                        $scope.apiInfoSelected = "";
                        $scope.apiInfoList = apiInfos;
                        $scope.apiInfoRequestMethod = "";
                        $scope.apiInfoRequestMethodList = [{ "name": "POST" }, { "name": "GET" }];
                        $scope.apiFormList = [];

                        $scope.$apply();
                    }
                    else {
                        alert("获取接口信息列表失败！");
                    }
                }
                else {
                    alert("获取接口信息列表失败！");
                }

            });

            $scope.TestApiClick = function () {

                var apiInfo = $scope.apiInfoSelected;

                var dataHttpHelper = new DataHttpHelper();
                if (apiInfo.requestMethod == "GET") {
                    if (apiInfo.url.indexOf("http", 0) >= 0) {
                        $.getJSON(apiInfo.url, "", function (data, textStatus, jqHRX) {
                            $("#responseView").JSONView(data);
                        });
                    }
                    else {
                        dataHttpHelper.GetJson(apiInfo.body, apiInfo.api, apiInfo.token, function (data, textStatus, jqXHR) {
                            $("#responseView").JSONView(data);
                        });
                    }
                }
                else {
                    dataHttpHelper.PostJson(apiInfo.body, apiInfo.api, apiInfo.token, function (data, textStatus, jqXHR) {
                        $("#responseView").JSONView(data);
                    });
                }
            };

            $scope.SwithApi = function () {
                var apiInfo = $scope.apiInfoSelected;
                var para = getUrlArgObject(apiInfo.url);
                $scope.apiFormList = [];
                for (var i = 0; i < para.length; i++) {

                    $scope.apiFormList.push(para[i]);
                }

                for (var i = 0; i < $scope.apiInfoRequestMethodList.length; i++) {
                    if (apiInfo.requestMethod == $scope.apiInfoRequestMethodList[i].name) {
                        $scope.apiInfoRequestMethod = $scope.apiInfoRequestMethodList[i];
                        break;
                    }
                }

            };


            $scope.SwithRequestMethod = function () {
                //alert($scope.apiInfoRequestMethod.name);
            };

            $scope.RefreshUrlInput = function () {


            };



        });
    </script>
</body>
</html>
